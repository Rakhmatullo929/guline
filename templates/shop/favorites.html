{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Избранное - GULINE{% endblock %}

{% block extra_js %}
<script>

document.addEventListener('DOMContentLoaded', function() {
    // Таймаут для загрузки
    const timeout = setTimeout(() => {
        console.error('Timeout waiting for favoritesManager');
        showEmptyFavorites();
    }, 5000); // 5 секунд
    
    // Ждем инициализации favoritesManager
    const checkFavoritesManager = () => {
        if (window.favoritesManager) {
            clearTimeout(timeout);
            initFavoritesPage();
        } else {
            setTimeout(checkFavoritesManager, 100);
        }
    };
    
    checkFavoritesManager();
});

function initFavoritesPage() {
    const favoritesManager = window.favoritesManager;
    if (!favoritesManager) {
        console.error('FavoritesManager not initialized');
        showEmptyFavorites();
        return;
    }

    // Получаем избранные товары
    const favorites = favoritesManager.getFavorites();
    
    if (favorites.length === 0) {
        showEmptyFavorites();
        return;
    }

    // Загружаем данные товаров с сервера
    loadFavoritesProducts(favorites);
}

function showEmptyFavorites() {
    const container = document.querySelector('.favorites-container');
    if (container) {
        container.innerHTML = `
            <div class="empty-favorites">
                <div class="empty-favorites-content">
                    <i class="fas fa-heart"></i>
                    <h2>Список избранного пуст</h2>
                    <p>Добавьте товары в избранное, чтобы они отображались здесь</p>
                    <a href="{% url 'shop:catalog' %}" class="btn btn-primary">
                        Перейти в каталог
                    </a>
                </div>
            </div>
        `;
    }
}

async function loadFavoritesProducts(productIds) {
    const container = document.querySelector('.favorites-container');
    if (!container) return;
    
    try {
        // Показываем индикатор загрузки
        container.innerHTML = `
            <div class="loading-favorites">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Загрузка избранных товаров...</p>
            </div>
        `;
        
        const response = await fetch('{% url "shop:api_favorites_data" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_ids: productIds
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.products && data.products.length > 0) {
                renderFavoritesProducts(data.products);
            } else {
                showEmptyFavorites();
            }
        } else {
            console.error('API response not ok:', response.status);
            showEmptyFavorites();
        }
    } catch (error) {
        console.error('Ошибка загрузки избранных товаров:', error);
        showEmptyFavorites();
    }
}

function renderFavoritesProducts(products) {
    const container = document.querySelector('.favorites-container');
    if (!container) return;

    if (products.length === 0) {
        showEmptyFavorites();
        return;
    }

    let html = `
        <div class="favorites-header">
            <div class="favorites-header-left">
                <h1>Избранные товары</h1>
                <span class="favorites-count">${products.length} товаров</span>
            </div>
            <div class="favorites-actions">
                <button class="btn btn-secondary" onclick="clearAllFavorites()">
                    <i class="fas fa-trash"></i>
                    Очистить все
                </button>
            </div>
        </div>
        <div class="favorites-grid">
    `;

    products.forEach(product => {
        html += `
            <div class="favorite-product-card" data-product-id="${product.id}">
                <div class="product-image">
                    <a href="{% url 'shop:product_detail' 0 %}".replace('0', product.slug)>
                        ${product.main_image ? 
                            `<img src="${product.main_image}" alt="${product.name}" loading="lazy">` :
                            `<div class="product-placeholder"><i class="fas fa-tshirt"></i></div>`
                        }
                        ${product.discount_percentage > 0 ? 
                            `<div class="discount-badge">-${product.discount_percentage}%</div>` : 
                            ''
                        }
                    </a>
                    <button class="remove-favorite-btn" onclick="removeFromFavorites(${product.id})" title="Удалить из избранного">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="product-info">
                    <h3 class="product-name">
                        <a href="{% url 'shop:product_detail' 0 %}".replace('0', product.slug)>${product.name}</a>
                    </h3>
                    <div class="product-category">
                        <a href="{% url 'shop:catalog' %}?category=${product.category.slug}">${product.category.name}</a>
                    </div>
                    <div class="product-price">
                        ${product.old_price ? 
                            `<span class="old-price">${product.old_price} ₽</span>` : 
                            ''
                        }
                        <span class="current-price">${product.price} ₽</span>
                    </div>
                    <div class="product-details">
                        <div class="product-gender">
                            <i class="fas fa-${product.gender === 'men' ? 'male' : product.gender === 'women' ? 'female' : 'child'}"></i>
                            ${product.gender === 'men' ? 'Мужская' : 
                              product.gender === 'women' ? 'Женская' : 
                              product.gender === 'kids' ? 'Детская' : 
                              'Унисекс'}
                        </div>
                        ${product.available_sizes.length > 0 ? 
                            `<div class="product-sizes">
                                <strong>Размеры:</strong> ${product.available_sizes.join(', ')}
                            </div>` : 
                            ''
                        }
                    </div>
                    <div class="product-actions">
                        <a href="{% url 'shop:product_detail' 0 %}".replace('0', product.id) class="btn btn-primary">
                            Подробнее
                        </a>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

function removeFromFavorites(productId) {
    const favoritesManager = window.favoritesManager;
    if (favoritesManager) {
        favoritesManager.removeFromFavorites(productId);
        
        // Удаляем карточку товара из DOM
        const card = document.querySelector(`[data-product-id="${productId}"]`);
        if (card) {
            card.remove();
        }
        
        // Проверяем, остались ли товары
        const remainingCards = document.querySelectorAll('.favorite-product-card');
        if (remainingCards.length === 0) {
            showEmptyFavorites();
        } else {
            // Обновляем счетчик
            const countElement = document.querySelector('.favorites-count');
            if (countElement) {
                countElement.textContent = `${remainingCards.length} товаров`;
            }
        }
    }
}

function clearAllFavorites() {
    if (confirm('Вы уверены, что хотите очистить весь список избранного?')) {
        const favoritesManager = window.favoritesManager;
        if (favoritesManager) {
            favoritesManager.clearFavorites();
            showEmptyFavorites();
        }
    }
}
</script>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header">
    <div class="container">
        <h1>Избранное</h1>
        <p>Ваши любимые товары</p>
    </div>
</section>

<!-- Favorites Content -->
<section class="favorites-section">
    <div class="container">
        <div class="favorites-container">
            <!-- Fallback контент для случаев без JavaScript -->
            <noscript>
                <div class="empty-favorites">
                    <div class="empty-favorites-content">
                        <i class="fas fa-heart"></i>
                        <h2>JavaScript требуется</h2>
                        <p>Для работы с избранным товарами необходимо включить JavaScript в вашем браузере</p>
                        <a href="{% url 'shop:catalog' %}" class="btn btn-primary">
                            Перейти в каталог
                        </a>
                    </div>
                </div>
            </noscript>
            
            <!-- Контент будет загружен через JavaScript -->
            <div class="loading-favorites" id="loading-indicator">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Загрузка избранных товаров...</p>
            </div>
        </div>
    </div>
</section>

<!-- CSRF Token для AJAX запросов (не используется, но оставляем для совместимости) -->
{% csrf_token %}
{% endblock %}
